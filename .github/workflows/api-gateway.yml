name: API Gateway Pipelines

on:
  workflow_dispatch:
    inputs:
      build_and_push_stg:
        description: 'Run Build & Push for Staging'
        required: false
        default: false
        type: boolean
      deploy_stg:
        description: 'Run Deploy for Staging'
        required: false
        default: false
        type: boolean
      build_and_push_prod:
        description: 'Run Build & Push for Production'
        required: false
        default: false
        type: boolean
      deploy_prod:
        description: 'Run Deploy for Production'
        required: false
        default: false
        type: boolean

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set environment and get last commit message
        id: setup
        run: |
          # Set environment tags for staging and production
          if [ "${{ github.event.inputs.build_and_push_stg }}" == "true" ]; then
            echo "STG_TAG=stg" >> $GITHUB_ENV
          fi
          if [ "${{ github.event.inputs.build_and_push_prod }}" == "true" ]; then
            echo "PROD_TAG=prod" >> $GITHUB_ENV
          fi
          
          # Get the last commit message
          echo "COMMIT_MSG=$(git log -1 --pretty=%B)" >> $GITHUB_ENV
          
          # Output the variables for use in later steps
          echo "STG_TAG=${{ env.STG_TAG }}"
          echo "PROD_TAG=${{ env.PROD_TAG }}"
          echo "COMMIT_MSG=${{ env.COMMIT_MSG }}"

  build_and_push_stg:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_and_push_stg == 'true' }}
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Docker Build & Push for Staging
        uses: ./.github/actions/docker-build-push
        with:
          acr_username: ${{ secrets.ACR_USERNAME }}
          acr_password: ${{ secrets.ACR_PASSWORD }}
          image_name: 'api-gateway'
          tag: ${{ env.STG_TAG }}
          folder: './api-gateway'

      - name: Send notification to Discord (Build Staging)
        uses: ./.github/actions/notify-discord
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          service: 'api-gateway'
          image: 'actionagent.azurecr.io/api-gateway:${{ env.STG_TAG }}'
          branch: '${{ github.ref_name }}'
          commit_message: '${{ env.COMMIT_MSG }}'
          triggered_by: ${{ github.actor }}
          time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          action: 'BUILD'

  deploy_stg:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_stg == 'true' }}
    needs: [setup, build_and_push_stg]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy API Gateway to Staging
        uses: ./.github/actions/deploy
        with:
          environment: ${{ env.STG_TAG }}
          deploy_command: 'kubectl apply -f deployment.yaml'

      - name: Send notification to Discord (Deploy Staging)
        uses: ./.github/actions/notify-discord
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          service: 'api-gateway'
          image: 'actionagent.azurecr.io/api-gateway:${{ env.STG_TAG }}'
          branch: 'main'
          commit_message: '${{ env.COMMIT_MSG }}'
          triggered_by: ${{ github.actor }}
          time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          action: 'DEPLOY'

  build_and_push_prod:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.build_and_push_prod == 'true' }}
    needs: setup
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
  
      - name: Docker Build & Push for Production
        uses: ./.github/actions/docker-build-push
        with:
          acr_username: ${{ secrets.ACR_USERNAME }}
          acr_password: ${{ secrets.ACR_PASSWORD }}
          image_name: 'api-gateway'
          tag: ${{ env.PROD_TAG }}
          folder: './api-gateway'

      - name: Send notification to Discord (Build Production)
        uses: ./.github/actions/notify-discord
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          service: 'api-gateway'
          image: 'actionagent.azurecr.io/api-gateway:${{ env.PROD_TAG }}'
          branch: 'dev'
          commit_message: '${{ env.COMMIT_MSG }}'
          triggered_by: ${{ github.actor }}
          time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          action: 'BUILD'

  deploy_prod:
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.deploy_prod == 'true' }}
    needs: [setup, build_and_push_prod]
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Deploy API Gateway to Production
        uses: ./.github/actions/deploy
        with:
          environment: ${{ env.PROD_TAG }}
          deploy_command: 'kubectl apply -f deployment.yaml'

      - name: Send notification to Discord (Deploy Production)
        uses: ./.github/actions/notify-discord
        with:
          webhook_url: ${{ secrets.DISCORD_WEBHOOK_URL }}
          service: 'api-gateway'
          image: 'actionagent.azurecr.io/api-gateway:${{ env.PROD_TAG }}'
          branch: '${{ github.ref_name }}'
          commit_message: '${{ env.COMMIT_MSG }}'
          triggered_by: ${{ github.actor }}
          time: $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          action: 'DEPLOY'
