name: Dev CI/CD

on:
  push:
    branches:
      - dev

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [ai-service, api-gateway, user-service]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Check if ${{ matrix.service }} changed
        id: check_changes
        run: |
          echo "Checking changes in ${{ matrix.service }}"
          if git diff --name-only origin/dev...HEAD | grep "^${{ matrix.service }}/" > /dev/null; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Login to ACR
        if: steps.check_changes.outputs.changed == 'true'
        run: echo "${{ secrets.DEV_ACR_PASSWORD }}" | docker login actionagent.azurecr.io -u ${{ secrets.DEV_ACR_USERNAME }} --password-stdin

      - name: Build & Push image
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          echo "Building and pushing ${{ matrix.service }}"
          docker build -t actionagent.azurecr.io/${{ matrix.service }}:dev ./${{ matrix.service }}
          docker push actionagent.azurecr.io/${{ matrix.service }}:dev

      - name: Send Discord Notification
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{"content": "[DEV] Service '${{ matrix.service }}' built and pushed successfully to actionagent.azurecr.io! \nBranch: '${{ github.ref }}'\nCommit: '${{ github.sha }}'\nCommit Message: '${{ github.event.head_commit.message }}'\nBuild Status: Success\nTriggered By: '${{ github.actor }}'\nTime: $(date)"}' \
            ${{ secrets.DISCORD_WEBHOOK_URL }}
