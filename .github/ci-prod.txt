name: Prod CI/CD

on:
  push:
    branches:
      - production

jobs:
  wait-for-approval:
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://your-prod-app.com  # optional
    steps:
      - name: Await manual approval
        run: echo "Waiting for manual approval in the 'production' environment."

  build-and-push:
    runs-on: ubuntu-latest
    needs: wait-for-approval
    strategy:
      matrix:
        service: [ai-service, api-gateway, user-service]

    steps:
      - uses: actions/checkout@v3

      - name: Login to ACR
        run: echo "${{ secrets.PROD_ACR_PASSWORD }}" | docker login actionagent.azurecr.io -u ${{ secrets.PROD_ACR_USERNAME }} --password-stdin

      - name: Build & Push Production Image
        run: |
          docker build -t actionagent.azurecr.io/${{ matrix.service }}:latest ./${{ matrix.service }}
          docker push actionagent.azurecr.io/${{ matrix.service }}:latest
